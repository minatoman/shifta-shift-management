{% extends "schedule/base.html" %}

{% block title %}ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - Shifta{% endblock %}

{% block header_title %}ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block extra_css %}
<style>
  /* PCç”¨ç®¡ç†è€…ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  @media (min-width: 768px) {
    .container {
      max-width: 1200px;
    }
    
    .admin-sidebar {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1.5rem;
      height: fit-content;
      position: sticky;
      top: 2rem;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: none;
      transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .ai-action-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      border: none;
    }
    
    .progress-ring {
      width: 120px;
      height: 120px;
      margin: 0 auto 1rem;
    }
    
    .progress-ring circle {
      fill: transparent;
      stroke: rgba(255,255,255,0.3);
      stroke-width: 8;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .progress-ring .progress {
      stroke: white;
    }
  }
  
  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
  }
  
  .status-active { background-color: #28a745; }
  .status-pending { background-color: #ffc107; }
  .status-error { background-color: #dc3545; }
  
  .quick-action-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    margin: 0.25rem;
    transition: all 0.2s ease;
  }
  
  .quick-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    color: white;
  }
  
  .ai-status {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  
  .ai-status.running {
    background: linear-gradient(45deg, #17a2b8, #20c997);
    color: white;
  }
  
  .ai-status.complete {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
  }
  
  .ai-status.error {
    background: linear-gradient(45deg, #dc3545, #fd7e14);
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆPCç”¨ï¼‰ -->
  <div class="col-lg-3 d-none d-lg-block">
    <div class="admin-sidebar">
      <h5 class="mb-3">
        <i class="bi bi-speedometer2"></i>
        ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      </h5>
      
      <div class="list-group list-group-flush">
        <a href="{% url 'schedule:admin_dashboard' %}" class="list-group-item list-group-item-action active">
          <i class="bi bi-house-door"></i>
          ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        </a>
        <a href="{% url 'schedule:admin_calendar' %}" class="list-group-item list-group-item-action">
          <i class="bi bi-calendar3"></i>
          ã‚·ãƒ•ãƒˆèª¿æ•´
        </a>
        <a href="{% url 'schedule:admin_staff' %}" class="list-group-item list-group-item-action">
          <i class="bi bi-people"></i>
          ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
        </a>
        <a href="{% url 'schedule:admin_settings' %}" class="list-group-item list-group-item-action">
          <i class="bi bi-gear"></i>
          ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
        </a>
        <a href="{% url 'schedule:admin_reports' %}" class="list-group-item list-group-item-action">
          <i class="bi bi-graph-up"></i>
          ãƒ¬ãƒãƒ¼ãƒˆ
        </a>
      </div>
      
      <hr>
      
      <div class="quick-actions">
        <h6>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
        <button class="quick-action-btn btn-sm" onclick="exportToExcel()">
          <i class="bi bi-file-earmark-excel"></i>
          Excelå‡ºåŠ›
        </button>
        <button class="quick-action-btn btn-sm" onclick="sendNotifications()">
          <i class="bi bi-bell"></i>
          ä¸€æ–‰é€šçŸ¥
        </button>
        <button class="quick-action-btn btn-sm" onclick="backupData()">
          <i class="bi bi-download"></i>
          ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        </button>
      </div>
    </div>
  </div>
  
  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="col-lg-9">
    <!-- æœŸé–“é¸æŠ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-calendar-range"></i>
          ã‚·ãƒ•ãƒˆä½œæˆæœŸé–“ã®é¸æŠ
        </h5>
      </div>
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">å¯¾è±¡æœŸé–“</label>
            <select class="form-select" name="period_id" onchange="this.form.submit()">
              {% for period in available_periods %}
                <option value="{{ period.id }}" {% if period.id == current_period.id %}selected{% endif %}>
                  {{ period.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <div class="mt-2">
              {% if current_period.is_request_open %}
                <span class="status-indicator status-active"></span>
                å¸Œæœ›æå‡ºæœŸé–“ä¸­ (ç· åˆ‡: {{ current_period.request_deadline|date:"n/j H:i" }})
              {% else %}
                <span class="status-indicator status-pending"></span>
                å¸Œæœ›æå‡ºç· åˆ‡æ¸ˆã¿
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-number">{{ stats.total_staff }}</div>
          <div>ç·ã‚¹ã‚¿ãƒƒãƒ•æ•°</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-number">{{ stats.submitted_requests }}</div>
          <div>å¸Œæœ›æå‡ºæ¸ˆã¿</div>
          <small>{{ stats.total_staff }}äººä¸­</small>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-number">{{ stats.requirements_set }}</div>
          <div>å¿…è¦äººæ•°è¨­å®šæ¸ˆã¿</div>
          <small>{{ current_period.days_count }}æ—¥ä¸­</small>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-number">
            {% if stats.completion_rate %}{{ stats.completion_rate }}%{% else %}0%{% endif %}
          </div>
          <div>å®Œæˆåº¦</div>
        </div>
      </div>
    </div>
    
    <!-- AIã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ© -->
    <div class="card ai-action-card mb-4">
      <div class="card-body">
        {% if ai_status.is_running %}
          <div class="ai-status running">
            <div class="d-flex align-items-center justify-content-center">
              <div class="spinner-border spinner-border-sm me-2" role="status"></div>
              <strong>AIãŒã‚·ãƒ•ãƒˆã‚’ä½œæˆä¸­ã§ã™...</strong>
            </div>
            <div class="progress mt-2">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   style="width: {{ ai_status.progress }}%"></div>
            </div>
            <small class="d-block mt-1">æ¨å®šæ®‹ã‚Šæ™‚é–“: {{ ai_status.estimated_time }}åˆ†</small>
          </div>
        {% elif ai_status.last_result %}
          <div class="ai-status {% if ai_status.last_result.success %}complete{% else %}error{% endif %}">
            <h5>
              <i class="bi bi-{% if ai_status.last_result.success %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
              {{ ai_status.last_result.message }}
            </h5>
            {% if ai_status.last_result.success %}
              <p class="mb-0">
                ä½œæˆæ—¥æ™‚: {{ ai_status.last_result.created_at|date:"n/j H:i" }} | 
                å®Ÿè¡Œæ™‚é–“: {{ ai_status.last_result.execution_time }}ç§’ |
                å‰²ã‚Šå½“ã¦æ•°: {{ ai_status.last_result.assignments_count }}ä»¶
              </p>
            {% endif %}
          </div>
        {% endif %}
        
        <div class="text-center">
          <div class="progress-ring mb-3">
            <svg>
              <circle cx="60" cy="60" r="45"></circle>
              <circle cx="60" cy="60" r="45" class="progress" 
                      style="stroke-dashoffset: {{ stats.progress_offset }}"></circle>
            </svg>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
              <strong style="font-size: 1.2rem;">{{ stats.completion_rate }}%</strong>
            </div>
          </div>
          
          <h4 class="mb-3">ğŸ¤– AIã‚·ãƒ•ãƒˆè‡ªå‹•ä½œæˆ</h4>
          <p class="mb-4">
            ã‚¹ã‚¿ãƒƒãƒ•ã®å¸Œæœ›ã¨å¿…è¦äººæ•°ã‚’åŸºã«ã€æœ€é©ãªã‚·ãƒ•ãƒˆã‚’è‡ªå‹•ã§ä½œæˆã—ã¾ã™ã€‚<br>
            å‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
          </p>
          
          <form method="post" id="aiForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="run_ai">
            <input type="hidden" name="period_id" value="{{ current_period.id }}">
            
            {% if not ai_status.is_running %}
              {% if stats.can_run_ai %}
                <button type="submit" class="btn btn-light btn-lg" id="runAiBtn">
                  <i class="bi bi-robot"></i>
                  AIã‚·ãƒ•ãƒˆè‡ªå‹•ä½œæˆã‚’å®Ÿè¡Œ
                </button>
              {% else %}
                <button type="button" class="btn btn-outline-light" disabled>
                  <i class="bi bi-exclamation-triangle"></i>
                  å‰ææ¡ä»¶ãŒä¸è¶³ã—ã¦ã„ã¾ã™
                </button>
                <div class="mt-2">
                  <small>
                    {% if not stats.has_requests %}å¸Œæœ›æå‡ºãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚{% endif %}
                    {% if not stats.has_requirements %}å¿…è¦äººæ•°è¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚{% endif %}
                  </small>
                </div>
              {% endif %}
            {% else %}
              <button type="button" class="btn btn-outline-light" disabled>
                <div class="spinner-border spinner-border-sm me-2"></div>
                å®Ÿè¡Œä¸­...
              </button>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
    
    <!-- æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ -->
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-clock-history"></i>
              æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
            </h6>
          </div>
          <div class="card-body p-0">
            <div class="list-group list-group-flush">
              {% for log in recent_logs %}
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ log.get_action_display }}</h6>
                    <small>{{ log.created_at|timesince }}å‰</small>
                  </div>
                  <p class="mb-1">{{ log.description }}</p>
                  <small class="{% if log.success %}text-success{% else %}text-danger{% endif %}">
                    <i class="bi bi-{% if log.success %}check-circle{% else %}x-circle{% endif %}"></i>
                    {% if log.success %}æˆåŠŸ{% else %}å¤±æ•—{% endif %}
                  </small>
                </div>
              {% empty %}
                <div class="list-group-item text-center text-muted">
                  ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã¯ã‚ã‚Šã¾ã›ã‚“
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-exclamation-triangle"></i>
              æ³¨æ„ãŒå¿…è¦ãªé …ç›®
            </h6>
          </div>
          <div class="card-body">
            {% if alerts %}
              {% for alert in alerts %}
                <div class="alert alert-{{ alert.level }} py-2" role="alert">
                  <i class="bi bi-{{ alert.icon }}"></i>
                  {{ alert.message }}
                </div>
              {% endfor %}
            {% else %}
              <div class="text-center text-muted">
                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                <p class="mt-2">å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // AIãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
  const aiForm = document.getElementById('aiForm');
  const runAiBtn = document.getElementById('runAiBtn');
  
  if (aiForm) {
    aiForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (confirm('AIã‚·ãƒ•ãƒˆä½œæˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢å­˜ã®å‰²ã‚Šå½“ã¦ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
        runAiBtn.disabled = true;
        runAiBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>å®Ÿè¡Œä¸­...';
        
        fetch(aiForm.action || window.location.href, {
          method: 'POST',
          body: new FormData(aiForm),
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // æˆåŠŸæ™‚ã¯è‡ªå‹•ã§ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => location.reload(), 2000);
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
            runAiBtn.disabled = false;
            runAiBtn.innerHTML = '<i class="bi bi-robot"></i> AIã‚·ãƒ•ãƒˆè‡ªå‹•ä½œæˆã‚’å®Ÿè¡Œ';
          }
        })
        .catch(error => {
          alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          runAiBtn.disabled = false;
          runAiBtn.innerHTML = '<i class="bi bi-robot"></i> AIã‚·ãƒ•ãƒˆè‡ªå‹•ä½œæˆã‚’å®Ÿè¡Œ';
        });
      }
    });
  }
  
  // é€²æ—çŠ¶æ³ã®å®šæœŸæ›´æ–°ï¼ˆAIå®Ÿè¡Œä¸­ã®å ´åˆï¼‰
  {% if ai_status.is_running %}
    setInterval(function() {
      fetch(window.location.href + '?ajax=1')
        .then(response => response.json())
        .then(data => {
          if (data.ai_status) {
            if (!data.ai_status.is_running) {
              location.reload();
            } else {
              // é€²æ—çŠ¶æ³ã®æ›´æ–°
              const progressBar = document.querySelector('.progress-bar');
              if (progressBar) {
                progressBar.style.width = data.ai_status.progress + '%';
              }
            }
          }
        })
        .catch(error => console.error('é€²æ—å–å¾—ã‚¨ãƒ©ãƒ¼:', error));
    }, 5000); // 5ç§’ã”ã¨ã«æ›´æ–°
  {% endif %}
});

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°
function exportToExcel() {
  if (confirm('ç¾åœ¨ã®ã‚·ãƒ•ãƒˆã‚’Excelãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
    window.location.href = '{% url "schedule:export_excel" %}?period_id={{ current_period.id }}';
  }
}

function sendNotifications() {
  if (confirm('å…¨ã‚¹ã‚¿ãƒƒãƒ•ã«ã‚·ãƒ•ãƒˆç¢ºå®šé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
    fetch('{% url "schedule:send_notifications" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        period_id: {{ current_period.id }},
        notification_type: 'shift_finalized'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚');
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
      }
    });
  }
}

function backupData() {
  if (confirm('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
    window.location.href = '{% url "schedule:backup_data" %}';
  }
}
</script>
{% endblock %}
