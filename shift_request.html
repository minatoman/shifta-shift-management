{% extends "schedule/base.html" %}

{% block title %}シフト希望提出 - Shifta{% endblock %}

{% block header_title %}シフト希望提出{% endblock %}

{% block header_actions %}
<button class="btn btn-link text-white" onclick="resetAllRequests()">
  <i class="bi bi-arrow-clockwise"></i>
</button>
{% endblock %}

{% block extra_css %}
<style>
  .request-day-item {
    border: none;
    margin-bottom: 0.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1rem;
    transition: all 0.2s ease;
  }
  
  .request-day-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .date-info {
    font-weight: 600;
    font-size: 1.1rem;
    color: #2d3748;
  }
  
  .date-weekday {
    font-size: 0.9rem;
    color: #718096;
    margin-left: 0.5rem;
  }
  
  .date-weekday.sunday { color: #e53e3e; }
  .date-weekday.saturday { color: #3182ce; }
  
  .request-btn-group {
    gap: 0.5rem;
  }
  
  .request-btn {
    flex: 1;
    padding: 0.75rem 0.5rem;
    border: 2px solid transparent;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    min-height: 44px;
  }
  
  .request-btn.active {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .request-btn.priority-1 {
    background-color: #fed7d7;
    color: #c53030;
    border-color: #feb2b2;
  }
  
  .request-btn.priority-1.active {
    background-color: #e53e3e;
    color: white;
    border-color: #e53e3e;
  }
  
  .request-btn.priority-2 {
    background-color: #e6fffa;
    color: #319795;
    border-color: #b2f5ea;
  }
  
  .request-btn.priority-2.active {
    background-color: #319795;
    color: white;
    border-color: #319795;
  }
  
  .request-btn.priority-3 {
    background-color: #ebf8ff;
    color: #3182ce;
    border-color: #bee3f8;
  }
  
  .request-btn.priority-3.active {
    background-color: #3182ce;
    color: white;
    border-color: #3182ce;
  }
  
  .summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: none;
  }
  
  .summary-item {
    text-align: center;
    padding: 0.5rem;
  }
  
  .summary-number {
    font-size: 1.5rem;
    font-weight: 700;
    display: block;
  }
  
  .summary-label {
    font-size: 0.8rem;
    opacity: 0.9;
  }
  
  .submit-section {
    position: sticky;
    bottom: 80px; /* ボトムナビゲーションの上 */
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    padding: 1rem;
    border-radius: 12px;
    margin: 1rem -0.75rem 0;
    box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
  }
  
  .deadline-warning {
    background: linear-gradient(45deg, #ff6b6b, #feca57);
    color: white;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 1rem;
    text-align: center;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
  }
  
  .floating-fab {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 1000;
    transition: all 0.2s ease;
  }
  
  .floating-fab:hover {
    transform: scale(1.1);
    color: white;
  }
  
  .auto-save-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1001;
  }
  
  .auto-save-indicator.show {
    opacity: 1;
  }
  
  .calendar-month-header {
    text-align: center;
    font-weight: 700;
    font-size: 1.2rem;
    color: #4a5568;
    margin: 1.5rem 0 1rem;
    padding: 0.5rem;
    border-bottom: 2px solid #e2e8f0;
  }
</style>
{% endblock %}

{% block content %}
<!-- 締切警告 -->
{% if period.is_request_open %}
  {% if days_until_deadline <= 2 %}
    <div class="deadline-warning">
      <i class="bi bi-clock-fill"></i>
      <strong>締切まで残り{{ days_until_deadline }}日！</strong>
      <br>
      <small>{{ period.request_deadline|date:"n月j日 H:i" }}まで</small>
    </div>
  {% endif %}
{% else %}
  <div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <strong>締切が過ぎています</strong>
    <br>
    希望の提出・変更はできません。
  </div>
{% endif %}

<!-- 期間情報 -->
<div class="card mb-3">
  <div class="card-body text-center">
    <h5 class="mb-1">{{ period.name }}</h5>
    <p class="text-muted mb-2">{{ period.start_date|date:"Y年n月j日" }} 〜 {{ period.end_date|date:"n月j日" }}</p>
    <div class="row">
      <div class="col">
        <small class="text-muted">締切</small>
        <div class="fw-bold">{{ period.request_deadline|date:"n/j H:i" }}</div>
      </div>
      <div class="col">
        <small class="text-muted">期間</small>
        <div class="fw-bold">{{ period.days_count }}日間</div>
      </div>
    </div>
  </div>
</div>

<!-- サマリーカード -->
<div class="summary-card">
  <div class="row text-center">
    <div class="col-4">
      <div class="summary-item">
        <span class="summary-number" id="holidayCount">0</span>
        <span class="summary-label">休み希望</span>
      </div>
    </div>
    <div class="col-4">
      <div class="summary-item">
        <span class="summary-number" id="workCount">0</span>
        <span class="summary-label">勤務可</span>
      </div>
    </div>
    <div class="col-4">
      <div class="summary-item">
        <span class="summary-number" id="priorityCount">0</span>
        <span class="summary-label">最優先</span>
      </div>
    </div>
  </div>
  <div class="mt-2 text-center">
    <small>タップして希望を変更できます</small>
  </div>
</div>

<!-- 希望提出フォーム -->
<form id="requestForm" data-period-id="{{ period.id }}">
  {% csrf_token %}
  
  {% regroup date_list by month as monthly_dates %}
  {% for month_group in monthly_dates %}
    <div class="calendar-month-header">
      {{ month_group.grouper|date:"Y年n月" }}
    </div>
    
    {% for date_info in month_group.list %}
      <div class="list-group-item request-day-item" data-date="{{ date_info.date|date:'Y-m-d' }}">
        <div class="d-flex justify-content-between align-items-center">
          <div class="date-info">
            {{ date_info.date|date:"j日" }}
            <span class="date-weekday {% if date_info.weekday == 0 %}sunday{% elif date_info.weekday == 6 %}saturday{% endif %}">
              ({{ date_info.weekday_name }})
            </span>
          </div>
          
          <div class="request-btn-group d-flex">
            <button type="button" 
                    class="request-btn priority-1 {% if date_info.current_priority == 1 %}active{% endif %}" 
                    data-priority="1"
                    data-date="{{ date_info.date|date:'Y-m-d' }}">
              休み
            </button>
            <button type="button" 
                    class="request-btn priority-2 {% if date_info.current_priority == 2 or not date_info.current_priority %}active{% endif %}" 
                    data-priority="2"
                    data-date="{{ date_info.date|date:'Y-m-d' }}">
              可
            </button>
            <button type="button" 
                    class="request-btn priority-3 {% if date_info.current_priority == 3 %}active{% endif %}" 
                    data-priority="3"
                    data-date="{{ date_info.date|date:'Y-m-d' }}">
              最優先
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endfor %}
</form>

<!-- 提出セクション -->
<div class="submit-section">
  {% if period.is_request_open %}
    <button type="button" class="btn btn-primary btn-lg w-100" onclick="submitRequests()">
      <i class="bi bi-check-circle"></i>
      この内容で希望を提出する
    </button>
    <div class="text-center mt-2">
      <small class="text-muted">
        <i class="bi bi-info-circle"></i>
        自動保存機能により、入力内容は自動で保存されます
      </small>
    </div>
  {% else %}
    <button type="button" class="btn btn-secondary btn-lg w-100" disabled>
      <i class="bi bi-lock"></i>
      提出期間が終了しました
    </button>
  {% endif %}
</div>

<!-- フローティングアクションボタン -->
<button class="floating-fab d-none" id="scrollToTop" onclick="scrollToTop()">
  <i class="bi bi-arrow-up"></i>
</button>

<!-- 自動保存インジケーター -->
<div class="auto-save-indicator" id="autoSaveIndicator">
  <i class="bi bi-cloud-check"></i>
  自動保存中...
</div>

<!-- 一括設定モーダル -->
<div class="modal fade" id="bulkSettingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">一括設定</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">設定する期間</label>
          <div class="row">
            <div class="col-6">
              <input type="date" class="form-control" id="bulkStartDate" value="{{ period.start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-6">
              <input type="date" class="form-control" id="bulkEndDate" value="{{ period.end_date|date:'Y-m-d' }}">
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">希望の種類</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="bulkPriority" id="bulk1" value="1">
            <label class="btn btn-outline-danger" for="bulk1">休み希望</label>
            
            <input type="radio" class="btn-check" name="bulkPriority" id="bulk2" value="2" checked>
            <label class="btn btn-outline-success" for="bulk2">勤務可</label>
            
            <input type="radio" class="btn-check" name="bulkPriority" id="bulk3" value="3">
            <label class="btn btn-outline-primary" for="bulk3">最優先</label>
          </div>
        </div>
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="weekendOnly">
            <label class="form-check-label" for="weekendOnly">
              土日のみに適用
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" onclick="applyBulkSetting()">適用</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let requestData = {};
let autoSaveTimeout;
let hasChanges = false;

document.addEventListener('DOMContentLoaded', function() {
  // 既存の希望を読み込み
  loadExistingRequests();
  
  // ボタンイベントの設定
  setupRequestButtons();
  
  // サマリーの初期化
  updateSummary();
  
  // スクロールイベント
  setupScrollEvents();
  
  // 自動保存の設定
  enableAutoSave();
  
  // 離脱警告の設定
  setupBeforeUnload();
});

function loadExistingRequests() {
  // 既存の希望データを読み込み
  {% for date_info in date_list %}
    requestData['{{ date_info.date|date:"Y-m-d" }}'] = {{ date_info.current_priority|default:2 }};
  {% endfor %}
}

function setupRequestButtons() {
  document.querySelectorAll('.request-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const date = this.dataset.date;
      const priority = parseInt(this.dataset.priority);
      
      // 同じ日の他のボタンから active クラスを削除
      const dayItem = this.closest('.request-day-item');
      dayItem.querySelectorAll('.request-btn').forEach(b => b.classList.remove('active'));
      
      // クリックされたボタンに active クラスを追加
      this.classList.add('active');
      
      // データを更新
      requestData[date] = priority;
      hasChanges = true;
      
      // サマリーを更新
      updateSummary();
      
      // 自動保存をトリガー
      triggerAutoSave();
      
      // ハプティックフィードバック（対応デバイスのみ）
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    });
  });
}

function updateSummary() {
  let holidayCount = 0;
  let workCount = 0;
  let priorityCount = 0;
  
  Object.values(requestData).forEach(priority => {
    switch(priority) {
      case 1: holidayCount++; break;
      case 2: workCount++; break;
      case 3: priorityCount++; break;
    }
  });
  
  document.getElementById('holidayCount').textContent = holidayCount;
  document.getElementById('workCount').textContent = workCount;
  document.getElementById('priorityCount').textContent = priorityCount;
}

function setupScrollEvents() {
  let scrollTimeout;
  window.addEventListener('scroll', function() {
    const scrollToTopBtn = document.getElementById('scrollToTop');
    
    if (window.scrollY > 300) {
      scrollToTopBtn.classList.remove('d-none');
    } else {
      scrollToTopBtn.classList.add('d-none');
    }
    
    // スクロール中はスタイルを調整
    clearTimeout(scrollTimeout);
    document.body.classList.add('scrolling');
    scrollTimeout = setTimeout(() => {
      document.body.classList.remove('scrolling');
    }, 150);
  });
}

function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
}

function triggerAutoSave() {
  clearTimeout(autoSaveTimeout);
  
  autoSaveTimeout = setTimeout(() => {
    autoSave();
  }, 1000); // 1秒後に自動保存
}

function autoSave() {
  if (!hasChanges) return;
  
  const indicator = document.getElementById('autoSaveIndicator');
  indicator.classList.add('show');
  
  fetch(window.location.href, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      'X-Auto-Save': 'true'
    },
    body: JSON.stringify({
      action: 'auto_save',
      requests: requestData,
      period_id: document.getElementById('requestForm').dataset.periodId
    })
  })
  .then(response => response.json())
  .then(data => {
    setTimeout(() => {
      indicator.classList.remove('show');
    }, 1000);
    
    if (data.success) {
      hasChanges = false;
      // localStorage.removeItem('shift_requests_' + data.period_id);
    }
  })
  .catch(error => {
    console.error('自動保存エラー:', error);
    setTimeout(() => {
      indicator.classList.remove('show');
    }, 1000);
  });
}

function submitRequests() {
  if (Object.keys(requestData).length === 0) {
    alert('希望が入力されていません。');
    return;
  }
  
  const confirmMessage = `
入力された希望を提出しますか？

休み希望: ${Object.values(requestData).filter(p => p === 1).length}日
勤務可: ${Object.values(requestData).filter(p => p === 2).length}日
最優先: ${Object.values(requestData).filter(p => p === 3).length}日

※提出後も締切まで修正可能です。
  `;
  
  if (!confirm(confirmMessage.trim())) {
    return;
  }
  
  const submitBtn = event.target;
  const originalText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>提出中...';
  
  fetch(window.location.href, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      action: 'submit',
      requests: requestData,
      period_id: document.getElementById('requestForm').dataset.periodId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('希望を提出しました！');
      hasChanges = false;
      
      // 成功時の視覚的フィードバック
      submitBtn.classList.add('btn-success');
      submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> 提出完了';
      
      setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-success');
        submitBtn.innerHTML = originalText;
      }, 3000);
      
    } else {
      alert('エラー: ' + data.message);
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  })
  .catch(error => {
    alert('通信エラーが発生しました。しばらく後に再試行してください。');
    console.error('提出エラー:', error);
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  });
}

function resetAllRequests() {
  if (confirm('全ての希望を「勤務可」にリセットしますか？')) {
    Object.keys(requestData).forEach(date => {
      requestData[date] = 2; // 勤務可
    });
    
    // UI を更新
    document.querySelectorAll('.request-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.priority === '2') {
        btn.classList.add('active');
      }
    });
    
    updateSummary();
    triggerAutoSave();
    hasChanges = true;
  }
}

function setupBeforeUnload() {
  window.addEventListener('beforeunload', function(e) {
    if (hasChanges) {
      e.preventDefault();
      e.returnValue = '変更が保存されていません。ページを離れますか？';
      return e.returnValue;
    }
  });
}

function enableAutoSave() {
  // ページフォーカス時の自動保存
  document.addEventListener('visibilitychange', function() {
    if (document.hidden && hasChanges) {
      autoSave();
    }
  });
  
  // 定期的な自動保存
  setInterval(() => {
    if (hasChanges) {
      autoSave();
    }
  }, 30000); // 30秒ごと
}

// 一括設定機能
function applyBulkSetting() {
  const startDate = new Date(document.getElementById('bulkStartDate').value);
  const endDate = new Date(document.getElementById('bulkEndDate').value);
  const priority = parseInt(document.querySelector('input[name="bulkPriority"]:checked').value);
  const weekendOnly = document.getElementById('weekendOnly').checked;
  
  let count = 0;
  Object.keys(requestData).forEach(dateStr => {
    const date = new Date(dateStr);
    
    if (date >= startDate && date <= endDate) {
      if (!weekendOnly || date.getDay() === 0 || date.getDay() === 6) {
        requestData[dateStr] = priority;
        count++;
        
        // UI更新
        const dayItem = document.querySelector(`[data-date="${dateStr}"]`);
        if (dayItem) {
          dayItem.querySelectorAll('.request-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.priority === priority.toString()) {
              btn.classList.add('active');
            }
          });
        }
      }
    }
  });
  
  updateSummary();
  triggerAutoSave();
  hasChanges = true;
  
  // モーダルを閉じる
  bootstrap.Modal.getInstance(document.getElementById('bulkSettingModal')).hide();
  
  alert(`${count}日分の希望を更新しました。`);
}

// エラーハンドリング
window.addEventListener('error', function(e) {
  console.error('JavaScript Error:', e.error);
  // エラー報告（本番環境では適切なサービスに送信）
});

// ネットワーク状態の監視
window.addEventListener('online', function() {
  if (hasChanges) {
    autoSave();
  }
});
</script>
{% endblock %}
